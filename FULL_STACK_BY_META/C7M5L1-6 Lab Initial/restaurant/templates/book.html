{% extends 'base.html' %}
{% load static %}

{% block content %}
<div class="layout-container">
    <div class="reservation-section">
        <h1>Book a Reservation</h1>

        <form method="post">
            {% csrf_token %}
            {{ form.non_field_errors }}

            <label for="id_first_name">First name:</label>
            {{ form.first_name }}

            <br>

            <label for="id_last_name">Last name:</label>
            {{ form.last_name }}

            <br>

            <label for="id_reservation_date">Date:</label>
            <input type="date" name="reservation_date" id="id_reservation_date" class="form-control" min="{{ today|date:'Y-m-d' }}" value="{{ form.reservation_date.value|default:today|date:'Y-m-d' }}">

            <label for="id_reservation_slot">Slot:</label>
            <select name="reservation_slot" id="id_reservation_slot">
                {% for i in slot_range %}
                    <option value="{{ i }}">{{ i }}:00</option>
                {% endfor %}
            </select>

            <button type="submit">Book</button>
        </form>
    </div>

    <div class="bookings">
        <h2>Today's Bookings ({{ bookings.count }})</h2>
        <ul>
            {% for booking in bookings %}
                <li>{{ booking.first_name }} - {{ booking.reservation_slot }}:00</li>
            {% empty %}
                <li>No bookings today.</li>
            {% endfor %}
        </ul>
    </div>
</div>

<script>
    function getCurrentHourIST() {
        const date = new Date();
        const istOffset = 5.5 * 60 * 60 * 1000; // IST is UTC+5:30
        const istTime = new Date(date.getTime() + istOffset);
        return istTime.getUTCHours() + (istTime.getUTCMinutes() / 60);
    }

    function updateSlots() {
        const dateInput = document.getElementById('id_reservation_date');
        const slotSelect = document.getElementById('id_reservation_slot');
        const selectedDate = dateInput.value;
        const today = new Date().toISOString().split('T')[0];
        const currentHour = getCurrentHourIST();

        if (!selectedDate) {
            slotSelect.innerHTML = '<option value="">No slots available</option>';
            return;
        }

        fetch('/get-available-slots/?date=' + selectedDate)
            .then(response => {
                if (!response.ok) throw new Error('Failed to fetch slots');
                return response.json();
            })
            .then(data => {
                slotSelect.innerHTML = '';
                if (data.available_slots && data.available_slots.length > 0) {
                    data.available_slots.forEach(slot => {
                        const hour = parseInt(slot.split(':')[0], 10);
                        const isPast = selectedDate === today && hour <= Math.floor(currentHour);
                        const option = document.createElement('option');
                        option.value = hour;
                        option.text = slot;
                        if (isPast) {
                            option.disabled = true;
                            option.style.color = 'grey';
                        }
                        slotSelect.appendChild(option);
                    });
                } else {
                    slotSelect.innerHTML = '<option value="">No slots available</option>';
                }
            })
            .catch(error => {
                slotSelect.innerHTML = '<option value="">Error loading slots: ' + error.message + '</option>';
            });
    }

    function updateBookings() {
        const selectedDate = document.getElementById('id_reservation_date').value;
        if (!selectedDate) {
            document.querySelector('.bookings').innerHTML = '<h2>Bookings</h2><p>Please select a date.</p>';
            return;
        }

        fetch('/get-bookings/?date=' + selectedDate)
            .then(response => {
                if (!response.ok) throw new Error('Failed to fetch bookings');
                return response.json();
            })
            .then(data => {
                const bookingsDiv = document.querySelector('.bookings');
                if (data.bookings && data.bookings.length > 0) {
                    let html = `<h2>Bookings for ${selectedDate} (${data.bookings.length})</h2><ul>`;
                    data.bookings.forEach(b => {
                        html += `<li>${b.first_name} - ${b.reservation_slot}:00</li>`;
                    });
                    html += '</ul>';
                    bookingsDiv.innerHTML = html;
                } else {
                    bookingsDiv.innerHTML = `<h2>Bookings for ${selectedDate} (0)</h2><p>No bookings on this date.</p>`;
                }
            })
            .catch(error => {
                document.querySelector('.bookings').innerHTML = `<h2>Bookings</h2><p>Error loading bookings: ${error.message}</p>`;
            });
    }

    function setDefaultSlot() {
        const dateInput = document.getElementById('id_reservation_date');
        const slotSelect = document.getElementById('id_reservation_slot');
        const today = new Date().toISOString().split('T')[0];
        const currentHour = getCurrentHourIST();

        if (!dateInput.value) {
            dateInput.value = today;
        }

        fetch('/get-available-slots/?date=' + dateInput.value)
            .then(response => {
                if (!response.ok) throw new Error('Failed to fetch slots');
                return response.json();
            })
            .then(data => {
                slotSelect.innerHTML = '';
                let defaultSlot = null;
                if (data.available_slots && data.available_slots.length > 0) {
                    data.available_slots.forEach(slot => {
                        const hour = parseInt(slot.split(':')[0], 10);
                        const isPast = dateInput.value === today && hour <= Math.floor(currentHour);
                        const option = document.createElement('option');
                        option.value = hour;
                        option.text = slot;
                        if (isPast) {
                            option.disabled = true;
                            option.style.color = 'grey';
                        }
                        slotSelect.appendChild(option);
                        if (!isPast && !defaultSlot) {
                            defaultSlot = hour;
                        }
                    });
                    slotSelect.value = defaultSlot || '';
                } else {
                    slotSelect.innerHTML = '<option value="">No slots available</option>';
                }
                updateBookings();
            })
            .catch(error => {
                slotSelect.innerHTML = '<option value="">Error loading slots: ' + error.message + '</option>';
            });
    }

    document.getElementById('id_reservation_date').addEventListener('change', () => {
        updateSlots();
        updateBookings();
    });

    window.addEventListener('load', setDefaultSlot);
</script>

<style>
    body {
        font-family: Arial, sans-serif;
        padding: 40px;
        background-color: #f4f4f4;
    }
    h1 {
        color: #333;
    }
    .layout-container {
        display: flex;
        gap: 40px;
        flex-wrap: wrap;
    }
    .reservation-section {
        flex: 1;
        min-width: 400px;
    }
    form {
        background-color: #fff;
        padding: 25px;
        border-radius: 8px;
        box-shadow: 0 0 10px rgba(0,0,0,0.1);
        max-width: 400px;
    }
    label {
        display: block;
        margin-top: 15px;
        margin-bottom: 5px;
    }
    input, select, button {
        width: 100%;
        padding: 8px;
        font-size: 14px;
    }
    button {
        margin-top: 20px;
        background-color: #007bff;
        color: white;
        border: none;
        cursor: pointer;
    }
    button:hover {
        background-color: #0056b3;
    }
    .errorlist {
        color: red;
        margin-bottom: 10px;
    }
    .bookings {
        flex: 1;
        min-width: 300px;
    }
    ul {
        padding-left: 20px;
    }
    option:disabled {
        color: grey;
    }
    @media (max-width: 768px) {
        .layout-container {
            flex-direction: column;
        }
    }
</style>
{% endblock %}